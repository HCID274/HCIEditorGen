# HCIAbilityKit 技术方案（插件双模块 + 智能中介者）

> 状态：冻结（M0-V2）
> 版本：v2
> 更新时间：2026-02-13

## 1. 重构目标

- 当前原型已具备 Import/Reimport 基础能力，但存在耦合高、复用差、复杂需求生产力不足的问题。
- 本次重构目标：建立 `数据 -> AI -> 资产` 的稳定管线，并将能力抽离为可复用插件。
- 核心价值：解决策划填表难、资产检索难、数据校验累。
- 当前阶段优先目标：先把“策划检索资产”做成真实可用能力，再逐步扩展到跨部门一致性校验。
- 本期交付范围：只交付检索模块，不做自动改写资产与审批/审阅 UI。

## 2. 架构选择（冻结）

```text
Plugins/HCIAbilityKit/
  HCIAbilityKit.uplugin
  Source/
    HCIAbilityKitRuntime/
    HCIAbilityKitEditor/
```

- `HCIAbilityKitRuntime`：数据模型、解析校验、可测试服务层。
- `HCIAbilityKitEditor`：Factory/Reimport、菜单命令、交互工具。
- 依赖必须单向：`Editor -> Runtime`。

## 3. 核心交互逻辑：智能中介者

### A. 智能调度层（语义路由）

- 采用轻量方案 B：`Skill(.md)` + `Python Script(.py)`。
- AI 根据用户意图匹配技能，再调用对应脚本执行。
- 涉及修改、删除、批量写入时必须执行授权门禁（说明原因 + 等待确认）。
- 执行边界：一次性低风险场景可直接 Prompt；可复现/可审计/固定流程场景必须走 Skill。

### B. 执行与审计层（串行双角色）

- 采用方案 A：生成者与审计者串行复核。
- 生成者负责提取与变更建议。
- 审计者独立检查逻辑可疑点（数值异常、字段冲突、遗漏约束）。
- 输出必须包含“可疑项清单”与“最终可执行建议”。

### C. 审阅交互层（步骤化对比）

- 采用方案 B：计划清单 + Diff 风格逐项对比。
- 用户可按字段局部采纳，不允许黑盒整包覆盖。
- 目标是可解释、可回滚、可追踪。

## 4. 真实业务场景约束（冻结）

- 先解决真实问题，不做“为了检索而检索”的演示功能。
- 首批固定查询场景（策划高频）：
  - `S1`：找“森林关卡可复用、伤害不高、偏控制”的技能候选。
  - `S2`：找“火系高爆发、适配 Boss 二阶段”的参考技能。
  - `S3`：找“与某技能风格相近但伤害更低”的替代资产。
- 每条检索结果必须给出命中理由（至少一条：字段匹配、标签匹配、规则匹配）。
- 空结果必须返回可执行建议（例如放宽条件、推荐相邻范围），禁止静默失败。

## 5. 职责分配（最小集合）

- `UHCIAbilityKitAsset`（Runtime）：承载派生资产字段与源信息。
- `FHCIAbilityKitParserService`（Runtime）：解析、校验、标准化输出。
- `UHCIAbilityKitFactory`（Editor）：导入/重导入编排、资产写入、错误反馈。
- `FHCIAbilityKitEditorModule`（Editor）：菜单/命令注册与工具入口。
- `HCIAbilityKit` Python 层：技能脚本执行与审计桥接（Step2 开始接入）。
- `HCIAbilityKit` 检索层（Step3 新增）：资产索引、查询解析、候选排序、命中理由生成。

## 6. 技术演进路线（Roadmap）

1. **Step 1 结构迁移**：迁移至插件双模块，保持现有行为不变。
2. **Step 2 服务抽离**：解析从 Factory 抽到 Runtime 服务层，引入 Python 脚本驱动。
3. **Step 3 AI 注入（检索优先）**：
   - Slice1：资产索引化 + 真实查询入口（先覆盖 AbilityKit）。
   - Slice2：排序与过滤策略增强 + 命中理由可解释。
   - Slice3：审计留痕（查询、候选、采纳）+ 误匹配保护。
4. **Step 4 UI 升级**：作为后续扩展，不在本期检索专精交付范围。

> Step3~Step4 的完整切片、门禁与风险收束，统一以：
> `Source/HCIEditorGen/文档/05_开发执行总方案_检索优先.md` 为执行依据。

## 7. 质量约束

- 失败不脏写：校验失败不得污染已有资产。
- 错误可定位：至少包含文件、字段、原因、建议。
- 功能增量顺序：先稳定 Import/Reimport，再引入 AI，不跳阶段。
- 结果可解释：检索结果必须给出命中依据，避免黑盒推荐。
- 场景对齐：新增能力必须能映射到固定业务场景 `S1/S2/S3`。

## 8. 验收口径

- Step 1 完成时：插件形态下 Import/Reimport 与当前行为一致。
- Step 2 完成时：Factory 只做编排，解析校验可独立测试。
- Step 3 完成时：
  - 能处理 `S1/S2/S3` 查询并返回候选资产；
  - 候选结果附带命中理由与排序依据；
  - 查询与结果写入审计日志；
  - 空结果有替代建议。
- Step 4 完成时：用户可视化审阅并逐项采纳建议。

## 9. 已冻结技术选型（2026-02-13）

- Python 运行环境：`UE 内置 Python`。
- 模型接入方式：在线 `API`（不做本地推理集成）。
- 授权门禁交互：`Custom Slate Panel` 可审计审批面板。
- 检索落地策略：先做项目内结构化索引与规则检索，再接 LLM 语义扩展。
