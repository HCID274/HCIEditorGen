# HCIAbilityKit 开发执行总方案（检索模块专精版，防发散冻结版）

> 状态：冻结（V2）
> 更新时间：2026-02-13
> 适用范围：`HCIAbilityKit` 的“策划资产语义检索”单模块交付（Step3 主线）

## 1. 模块定位与边界（先定死）

- 本期只交付一个模块：`Ability Semantic Retrieval`（能力资产语义检索）。
- 目标：让策划在 UE 中用自然语言快速找到可复用技能资产，并看到“为什么命中”。
- 面试定位：展示“可解释、可评测、可降级、可审计”的检索工程能力。
- 非目标（本期明确不做）：
  - 自动改写资产或批量写盘；
  - 字段 Diff 审阅 UI 与审批面板；
  - 跨部门一致性校验规则；
  - 全资产类型泛化（本期仅 `UHCIAbilityKitAsset`）。

## 2. 真实场景（固定，不随意改）

- `S1`：找“森林关卡可复用、伤害不高、偏控制”的技能候选。
- `S2`：找“火系高爆发、适配 Boss 二阶段”的参考技能。
- `S3`：找“与 fire_01 风格相近但伤害更低”的替代资产。

### 场景通过标准（统一）

- 每次查询返回 TopK 候选或可执行的空结果建议。
- 每条候选必须包含命中理由（字段/标签/规则至少一条）。
- 查询过程可追溯（查询词、候选、得分、最终动作）。

## 3. Prompt 与 Skill 的使用边界（冻结）

- 直接 Prompt（快路径）：
  - 查询改写、同义词补全、临时分析建议（只读、低风险、一次性）。
- Skill 体系（生产路径）：
  - 资产索引、查询解析、候选召回、排序解释、审计日志、降级策略。
- 判定规则（命中任一必须走 Skill）：
  - 需要复现；
  - 需要审计；
  - 需要团队共享规则；
  - 会进入固定流程（非一次性）。

## 4. 专精深度设计（六层）

- `D1 领域语义层`：固定能力标签体系（元素/伤害档位/控制倾向/使用场景）。
- `D2 混合召回层`：结构化过滤 + 规则语义扩展 + 可选 LLM 查询改写。
- `D3 排序打分层`：可配置权重打分，不硬编码单一排序。
- `D4 解释生成层`：候选输出命中证据，拒绝黑盒结果。
- `D5 评测基准层`：固定查询集评估 TopK 命中与延迟。
- `D6 可靠性层`：LLM 失败降级规则检索，链路持续可用。

## 5. 架构落位（与现有插件保持一致）

```text
HCIAbilityKitRuntime
  - ParserService（已完成）
  - SearchIndexService（索引构建/增量更新）
  - QueryModel / RetrievalService / RankingService / ExplainService

HCIAbilityKitEditor
  - SearchCommand（先命令入口）
  - SearchPanel（后续可选增强）
  - SearchAuditLogger

Python
  - skill scripts（查询改写、规则增强、审计补充）
```

## 6. 全量切片计划（唯一执行主线）

### Step3：检索模块专精主线

- `Step3-Slice1` 领域语义与索引结构冻结
  - 输出：`AbilitySearchDocument` 字段规范 + 索引结构定义。
  - 门禁：索引字段覆盖 `S1/S2/S3` 的检索需求。
- `Step3-Slice2` 索引构建与增量刷新
  - 输出：`SearchIndexService`（全量构建 + 增量刷新 + 统计信息）。
  - 门禁：可稳定索引当前资产并输出数量、字段覆盖率、更新时间。
- `Step3-Slice3` 查询解析与混合召回
  - 输出：`SearchQuery` 模型 + 规则召回器 + TopK 候选。
  - 门禁：`S1/S2/S3` 可返回候选或空结果建议，不允许静默失败。
- `Step3-Slice4` 排序与命中理由
  - 输出：多维打分器 + `HitReasons` 解释生成。
  - 门禁：每条候选均有理由，排序结果可复现。
- `Step3-Slice5` 评测基准与调参闭环
  - 输出：固定查询基准集（含 `S1/S2/S3` 扩展集）+ 离线评测脚本。
  - 门禁：产出 Top3 命中率与 P50/P95 延迟报告。
- `Step3-Slice6` 审计与降级可靠性
  - 输出：查询审计日志 + `RuleProvider/LLMRewriteProvider` 降级链路。
  - 门禁：LLM 不可用时查询可用率保持 100%，审计字段完整。

### Step4：后续扩展（不在本期交付范围）

- 跨部门一致性校验；
- 审阅 UI / 审批面板；
- 资产建议变更与局部采纳。

## 7. 每个切片固定执行模板（强制）

1. 冻结切片目标并写入 `00_总进度.md`。
2. 完成实现并命令行编译通过。
3. 输出 UE 手测步骤与 Pass/Fail 标准（由你执行）。
4. 记录测试结果与证据，再推进下一切片。
5. 未 Pass 禁止进入下一切片。

## 8. 面试量化指标（必须可展示）

- `K1` 检索效率：固定场景平均耗时相对人工检索明显下降。
- `K2` Top3 可用命中率：目标 `>= 80%`（基准集评测）。
- `K3` 解释覆盖率：候选结果命中理由覆盖率 `= 100%`。
- `K4` 降级可用率：LLM 不可用时检索链路可用率 `= 100%`。
- `K5` 审计完整率：查询日志关键字段完整率 `= 100%`。

## 9. 风险与收束策略（防发散）

- 风险：范围扩张成“大而全 AI 平台”。
  - 收束：任何新增项必须映射 `S1/S2/S3`，不能映射即延期。
- 风险：过早做 UI，挤占核心检索深度。
  - 收束：先完成索引、召回、排序、评测，再做面板增强。
- 风险：过度依赖 LLM 导致不稳定。
  - 收束：LLM 仅用于改写增强，规则检索始终是主路径。

## 10. 变更规则（冻结）

- 本文档是 Step3 唯一执行主计划，后续切片按此顺序推进。
- 任何主线调整，必须先更新本文档与 `00_总进度.md`，再改代码。
- 不允许口头改路线；所有路线变化必须文档化并标日期。
