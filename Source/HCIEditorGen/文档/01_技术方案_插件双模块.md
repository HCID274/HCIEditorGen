# HCIAbilityKit 技术方案（插件双模块 + 资产审计优先）

> 状态：冻结（M0-V3）
> 版本：v3
> 更新时间：2026-02-21

## 1. 重构目标

- 当前方向从“检索实验”升级为“资产审计工具主线”。
- 核心交付：在 UE 编辑器内完成大规模资产扫描、规则审计、风险报告与可追踪复核。
- 本期目标（半月内）：完成 C++ 高性能审计骨架与可演示闭环。

## 2. 架构选择（冻结）

```text
Plugins/HCIAbilityKit/
  HCIAbilityKit.uplugin
  Source/
    HCIAbilityKitRuntime/
    HCIAbilityKitEditor/
```

- `HCIAbilityKitRuntime`：规则模型、扫描服务、指标提取、报告结构。
- `HCIAbilityKitEditor`：审计命令入口、进度反馈、结果面板、导出工具。
- 依赖必须单向：`Editor -> Runtime`。

## 3. 核心能力分层

### A. 扫描执行层（主链路，必须无阻塞）

- Stage B 启动前先接入“种子资产”集合（真实高面数 `UStaticMesh`），作为审计样本基座。
- 资产枚举基于 `AssetRegistry + FAssetData`，禁止默认全量 `LoadObject`。
- 扫描执行采用异步分片（TaskGraph/Async），UI 线程仅负责进度与交互。
- 扫描结果按批次汇聚，支持中断、重试、继续。

### B. 审计规则层（主链路，必须可配置）

- 固定规则：命名规范、目录规范、基础性能阈值、字段一致性。
- 审计结果统一结构：`asset_path/rule_id/severity/reason/hint/evidence`。
- 规则执行与结果汇总在 Runtime，Editor 仅做展示与导出。
- 规则扩展方式：通过 `IHCIAbilityAuditRule + RuleRegistry` 注入新规则，避免改动扫描主流程。
- 一期业务规则必须覆盖三维：
  - 资产规范合规：`TextureNPOTRule`、`HighPolyAutoLODRule`；
  - 关卡场景排雷：`MissingCollisionRule`、`DefaultMaterialRule`；
  - 命名溯源整理：`MetadataNamingRule`、`ArchiveMoveRule`。

### C. 内存控制层（主链路，必须稳定）

- 元数据扫描路径不加载资产体。
- 深度检查路径采用小批量加载与主动释放策略（`FStreamableManager`/等效机制：Batch Load -> Analyze -> Release）。
- 每批分析结束后清理强引用，并按节流策略调用 `CollectGarbage`，防止 10k 审计持续累积内存。
- 记录峰值内存与处理批次，避免编辑器长时间卡顿。
- 扫描前做状态过滤：`Locked` 或 `Dirty 且无法安全读取` 的资产跳过并记录原因，禁止强行读取。

### C.1 Triangle Count 提取策略（冻结）

- 一级路径：读取 `AssetRegistry Tag`（例如 `hci_triangles_lod0`）。
- 二级路径：Tag 缺失时，在 Stage D 执行分批加载，提取 `StaticMesh LOD0 Triangles`。
- 口径优先级：真实网格提取值（actual）高于 JSON 预置值（expected）；冲突触发 `TriangleExpectedMismatchRule`。
- 证据要求：每条性能判定必须记录 `triangle_source(tag_cached/batch_loaded/unavailable)`。

### C.2 引用链契约（冻结）

- `UHCIAbilityKitAsset` 增加 `RepresentingMesh`（`TSoftObjectPtr<UStaticMesh>`），用于指向真实项目网格。
- 10k 合成数据导入时，允许按“种子网格清单”给每条资产分配 `RepresentingMesh` 路径。
- 种子清单路径统一采用 UE 长对象路径（`/Game/.../Asset.Asset`）；文件系统路径解析不在 Python 脚本中执行。
- 扫描阶段不强制加载该网格；仅在深度提取阶段分批加载并调用 `GetNumTriangles(0)`。
- 目标：审计结果必须可追踪到真实网格路径，而非仅依赖 JSON 离线字段。

### D. Agent 执行层（Stage E/F）

- 指令解析输出 `Plan JSON`，执行器只认结构化计划，不直接执行自由文本。
- Tool 调用必须先过 `Tool Registry` 能力声明校验（`read_only/write/destructive`）。
- Tool Registry 一期必须包含：`SetTextureMaxSize`、`SetMeshLODGroup`、`ScanLevelMeshRisks`、`NormalizeAssetNamingByMetadata`、`RenameAsset`、`MoveAsset`。
- Tool 参数必须命中冻结 `args_schema`（枚举与边界），不允许自由字段。
- 写操作必须先产出 `Dry-Run Diff` 并经过用户确认。
- 交互兜底：可视 Actor 走 `Camera Focus`，纯资产走 `GEditor->SyncBrowserToObjects`。
- 执行安全策略固定：
  - `MAX_ASSET_MODIFY_LIMIT = 50`（硬阈值拦截）；
  - `ScopedTransaction` 全单事务（All-or-Nothing）；
  - SourceControl 启用时 `Fail-Fast`；未启用时进入“离线本地模式”并提示 Warning。
- 一期权限与日志采用本地 Mock：本地角色映射 + 本地文件日志。
- 未命中权限映射用户默认 `Guest(read_only)`。

## 4. 真实业务场景约束（冻结）

- `S1`：项目发版前，快速扫描全量资产，识别高风险性能浪费项。
- `S2`：美术提交后，自动发现命名/目录/基础参数不合规项。
- `S3`：针对疑似问题资产，生成可读审计报告供 TA/客户端协作复核。
- `S3.1`：策划将 `HCIAbilityKitAsset` 拖入场景时，可通过 `RepresentingMesh` 看到真实代表模型。
- `S4`：关卡体检时，识别 `StaticMeshActor` 缺失碰撞体或默认材质，并支持一键定位（Actor 用 Camera Focus）。
- `S5`：执行“整理临时目录资产”时，读取 `UAssetImportData/AssetUserData` 溯源信息，自动前缀命名并批量归档到规范路径。

## 5. 职责分配（最小集合）

- `Runtime`
  - `AssetScanService`：异步分片扫描
  - `SeedMeshBindingService`：种子网格清单读取与 `RepresentingMesh` 绑定策略
  - `AuditRuleService`：规则执行与严重级别归一
  - `AuditRuleRegistry`：规则注册、启停与排序
  - `LevelRiskScanService`：关卡 Actor 风险扫描（Collision/Material）
  - `MetadataNamingService`：读取导入元数据并生成命名/归档提案
  - `AuditReportService`：结果汇总与导出结构
  - `MemoryBudgetPolicy`：批次与峰值内存约束
  - `PlanValidationService`：Plan JSON 校验与风险分级
  - `ToolRegistryService`：Tool 能力声明与白名单校验
  - `DryRunDiffService`：生成标准化修改前后差异
  - `ExecutionSafetyPolicy`：阈值拦截、事务、Fail-Fast 策略
  - `LocalAuthService`：本地用户名映射权限（Mock）
  - `LocalAuditLogService`：本地执行日志落盘
- `Editor`
  - `AuditCommand`：审计任务启动/停止
  - `AuditPanel`：进度、吞吐、内存、结果展示
  - `AuditExportAction`：JSON/CSV 报告导出
  - `AbilityKitPreviewActor`：内置 `UStaticMeshComponent`，读取 `RepresentingMesh` 并在场景中可视化
  - `AbilityKitPreviewActor`（编辑器同步）：`PostEditChangeProperty` 响应资产或路径变化并自动刷新网格
  - `AgentPanel`：自然语言输入、Plan 预览、执行确认
  - `DiffReviewList`：Dry-Run Diff 列表
  - `CameraFocusAction`：选中 Diff 项快速定位资产
  - `ContentBrowserSyncAction`：纯资产定位高亮（`SyncBrowserToObjects`）
## 6. 技术演进路线（Roadmap）

1. **Stage A 文档与契约冻结**：审计目标、规则契约、`RepresentingMesh` 引用链与启动门禁冻结。
2. **Stage B C++ 异步扫描主链路**：先接入种子资产并打通引用链，再实现非阻塞扫描与进度回传。
3. **Stage C 规则审计与报告闭环**：产出可追踪可导出的审计结果。
   - 一期规则闭环必须实现三维：`TextureNPOTRule + HighPolyAutoLODRule`、`MissingCollisionRule + DefaultMaterialRule`、`MetadataNamingRule + ArchiveMoveRule`。
4. **Stage D 内存与吞吐优化**：批次策略、峰值监控、真实网格面数提取稳定性回归。
5. **Stage E Agent 安全执行**：Tool Registry 白名单、Dry-Run 预演、确认门禁、`ScopedTransaction`、`Checkout/Revert`，并覆盖 Level 风险扫描与命名归档工具。
6. **Stage F 指令解析与执行编排**：自然语言到 Plan JSON（含“整理临时目录资产”等意图），执行器按步骤调用工具并输出可追踪证据。

## 7. 质量约束

- Runtime 禁止依赖 Editor-only 模块。
- 审计失败不得脏写资产。
- 所有错误必须可定位：`asset/file/rule/reason/hint`。
- 扫描过程不得阻塞编辑器主交互。
- 写操作未确认不得执行。
- 超过 `MAX_ASSET_MODIFY_LIMIT` 必须拦截。
- SourceControl 未启用必须给出“离线本地模式”提示；启用后 `Checkout` 失败必须立即终止（Fail-Fast）。
- 未命中权限映射用户必须降级为 `Guest(read_only)`。

## 8. 验收口径（半月 Demo）

- 元数据扫描：10k 资产可完成扫描并输出报告。
- 真实性：10k 资产具备真实 `RepresentingMesh` 引用，审计可追踪到项目内网格。
- 交互体验：扫描期间编辑器可继续操作（无明显卡死）。
- 审计结果：每条异常均含规则ID、原因、建议与证据。

## 9. 已冻结技术选型（2026-02-15）

- 扫描基线：`AssetRegistry + FAssetData`。
- 并发基线：UE 异步任务系统（TaskGraph/Async，按实现选择其一）。
- 报告格式：JSON（主）+ CSV（可选）。

## 10. 储备池（可选增强）

- 三级记忆增强（长期 SOP 压缩 + 主动推荐）。
- Web Dashboard 管理看板。
- 无感鉴权 + 后端权限中心。
- 记忆门禁与 TTL 细则（延期到 Phase 3）。
- 线上 KPI 监控体系（延期到 Phase 3）。
