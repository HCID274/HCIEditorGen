# HCIAbilityKit 总进度（重构 V3）

> 项目根目录：`D:\1_Projects\04_GameDev\UE_Projects\HCIEditorGen`
> 引擎版本：`UE 5.4.4`
> 更新时间：`2026-02-22`
> 当前阶段：`Stage C（Slice C4 待启动）`
> 当前策略：`先收尾资产审计主链路(B4->D3) -> 再进入E/F Agent主线 -> 每切片停测`

## 1. 范围冻结（唯一主线）

- 仅做 `HCIAbilityKit`，不扩展到无关系统。
- 固定架构：`HCIAbilityKitRuntime + HCIAbilityKitEditor`（插件双模块）。
- 固定目标：交付 `Smart Asset Auditor`（资产扫描 + 规则审计 + 报告导出）。
- 固定流程：`计划 -> 执行 -> 审阅`，敏感操作必须授权门禁。
- 本期范围收束：仅完成 C++ 高性能审计主链路。
- 下一阶段目标：在 D3 后追加 `Stage E（Agent 安全执行）` 与 `Stage F（指令解析与编排）`。

## 2. 已完成事实（历史基线）

- 插件双模块迁移（Step1）完成并 UE 手测通过。
- 解析服务抽离与 Python Hook（Step2）完成并 UE 手测通过。
- 检索实验线（Step3-Slice1~3）代码与基础门禁已完成，作为历史技术基线保留。
- 已补充 10k 合成数据生成能力与验证记录（用于后续性能/语义测试）。

## 3. 当前主线 Roadmap（V3）

### Stage A 文档与契约冻结（已完成）

- 目标：完成路线重规划、审计契约、半月执行计划冻结。
- 完成标准：`00/01/05` 与测试记录口径一致。

### Stage B C++ 异步扫描主链路

- 目标：先完成“种子资产接入 + 引用链打通”，再基于 `AssetRegistry + FAssetData` 完成非阻塞扫描。
- 完成标准：10k 数据资产可真实指向项目内 `UStaticMesh`；扫描期间编辑器可继续操作；`Locked/Dirty` 风险资产可安全跳过并留痕。

### Stage C 规则审计与报告闭环

- 目标：命名/目录/基础性能规则落地，统一异常结构，导出 JSON 报告。
- 一期规则闭环（缺一不可）：`TextureNPOTRule + HighPolyAutoLODRule`（资产规范合规）、`MissingCollisionRule + DefaultMaterialRule`（关卡场景排雷）、`MetadataNamingRule + ArchiveMoveRule`（命名溯源整理）。
- 完成标准：每条异常包含 `rule_id/reason/hint/evidence`。

### Stage D 内存与吞吐优化

- 目标：分批加载与释放策略、峰值内存与吞吐监控。
- 完成标准：批量审计稳定，无明显内存失控。

### Stage E Agent 安全执行

- 目标：建立“Dry-Run 预演 + 确认门禁 + 可撤销事务 + SourceControl 安全前置”闭环。
- 一期冻结策略：`MAX_ASSET_MODIFY_LIMIT=50`、`All-or-Nothing`、`Fail-Fast`、本地 Mock 鉴权与日志。
- 细则冻结：`args_schema` 枚举边界、Actor/资产双路径定位（`Camera Focus` / `SyncBrowserToObjects`）、未命中用户默认 `Guest(read_only)`。
- SourceControl 细则：未启用时进入“离线本地模式”并 Warning；启用后 `Checkout` 失败立即终止。
- 一期 Tool Registry 必须覆盖三维业务：`SetTextureMaxSize`、`SetMeshLODGroup`、`ScanLevelMeshRisks`、`NormalizeAssetNamingByMetadata`、`RenameAsset`、`MoveAsset`。
- 完成标准：破坏性操作必须可预演、可确认、可撤销，失败路径无脏写。

### Stage F 指令解析与执行编排

- 目标：自然语言转结构化执行计划（Plan JSON），并落地可追踪执行器。
- 一期契约重点：`Plan JSON` 字段冻结 + `Tool Registry` 能力声明 + Dry-Run Diff 标准化。
- 一期意图覆盖：除“面数/贴图合规”外，必须支持“关卡排雷”与“整理临时目录资产（命名+归档）”。
- 完成标准：输出计划可解释，执行结果可追踪，失败可收敛。

## 4. 测试门禁（强制）

- 每个切片必须执行：编译 -> UE 手测 -> 记录。
- 用户未明确 `Pass`，不得进入下一切片。
- 记录目录：`Source/HCIEditorGen/文档/测试记录/`
- 测试源数据：`SourceData/AbilityKits/`

## 5. 当前切片（下一步）

- 切片编号：`Stage C - Slice C4`
- 当前状态：`C3 已获用户 Pass；C4 待启动`
- 切片目标：JSON 报告导出（含 `triangle_source` 与规则证据）。
- 通过后动作：进入 `Stage D - Slice D1`（深度检查批次策略与分批加载释放）。

## 6. 文档索引（冻结）

- 技术方案：`Source/HCIEditorGen/文档/01_技术方案_插件双模块.md`
- 测试门禁：`Source/HCIEditorGen/文档/02_测试门禁与节奏.md`
- 契约规范：`Source/HCIEditorGen/文档/03_Schema_v1与错误契约.md`
- 结构总览：`Source/HCIEditorGen/文档/04_代码框架总览_树状图.md`
- 执行总方案：`Source/HCIEditorGen/文档/05_开发执行总方案_资产审计.md`
- 生成算法：`Source/HCIEditorGen/文档/06_合成数据生成算法说明.md`

## 7. 进度日志

- `2026-02-12 ~ 2026-02-13`：Step1~Step3（检索实验线）完成既定切片并形成基线代码。
- `2026-02-15`：完成 10k 合成数据生成脚本与验证（语义鸿沟 + 复合陷阱）。
- `2026-02-15`：路线重规划为 V3：资产审计主链路优先；并同步更新 `00/01/05` 权威文档。
- `2026-02-15`：根据评审补齐缺失点：在 `03` 冻结 Triangle Count 提取契约与 RuleRegistry 约束，在 `06` 增加性能陷阱定义并同步生成脚本字段（`virtual_path/triangle_count_lod0`）。
- `2026-02-15`：根据风险评审进一步收口：执行主计划文件重命名为 `05_开发执行总方案_资产审计.md`，并补充 Locked/Dirty 资产跳过策略。
- `2026-02-21`：范围调整：先收尾 Stage A~D（资产审计闭环），再进入 Stage E/F（Agent 安全执行与指令编排）。
- `2026-02-15`：新增 StageA-SliceA3 文档冻结项：Stage B 启动采用“种子资产导入 + RepresentingMesh 引用链 + 真实面数追踪”实战方案。
- `2026-02-15`：吸收 StageA-SliceA3 风险评审补充：Stage D 批次加载释放与 GC 节流、`seed_mesh_manifest` UE 长路径边界、`TriangleExpectedMismatchRule`（actual vs expected）告警口径。
- `2026-02-15`：StageB-SliceB0 工具链落地：新增 `hci_build_seed_mesh_manifest.py`（build/validate），并在生成脚本中接入 `--seed-mesh-manifest -> representing_mesh` 自动绑定与单测。
- `2026-02-19`：在用户授权下完成 Seed 网格命名整改：新增 `hci_inspect_seed_assets.py` 与 `hci_rename_seed_meshes.py`，已将 `/Game/Seed` 下 12 个 StaticMesh 批量改名为 `SM_*` 规范并复检通过（命名不合规从 12 降至 0）。
- `2026-02-19`：完成 StageB-SliceB0 命令链验证：`hci_build_seed_mesh_manifest.py build/validate` 通过（manifest=12），并完成 `hci_generate_synthetic_assets.py --count 10000 --seed-mesh-manifest ...`（`representing_mesh_assigned=10000`）。
- `2026-02-19`：用户完成 UE 手测并反馈 `StageB-SliceB0 Pass`，主线切换到 `StageB-SliceB1`。
- `2026-02-19`：完成 StageB-SliceB1 代码实现：新增 `RepresentingMeshPath` 解析、`UHCIAbilityKitAsset::RepresentingMesh` 字段、Factory `E1006` 校验与 Import/Reimport 绑定；外部 Build 受 Live Coding 门禁阻断，待 UE 侧重编译后手测确认。
- `2026-02-19`：在用户关闭 UE 后复编译通过：`Build.bat HCIEditorGenEditor Win64 Development -Project=... -WaitMutex -FromMSBuild` 成功，B1 进入“待 UE 手测”状态。
- `2026-02-19`：用户完成 B1 导入/重导回归，确认非法样例 `E1006` 日志与失败弹窗均生效，反馈 `StageB-SliceB1 Pass`；主线切换到 `StageB-SliceB2`。
- `2026-02-19`：完成 StageB-SliceB2 第一版实现：Runtime 新增 `FHCIAbilityKitAuditScanService`（`AssetRegistry + FAssetData` 全量枚举，不加载资产对象），并在 `UHCIAbilityKitAsset::GetAssetRegistryTags` 写入 `hci_id/hci_display_name/hci_damage/hci_representing_mesh` 标签。
- `2026-02-19`：Editor 新增控制台命令 `HCIAbilityKit.AuditScan [log_top_n]`，可输出扫描统计与样本行；外部编译通过，B2 进入“待 UE 手测”状态。
- `2026-02-19`：用户完成 B2 手测并反馈 `Pass`：`HCIAbilityKit.AuditScan 20` 输出 `assets=2`，合法样例行字段完整；历史测试资产 `/Game/HCI/Data/TestSkill.TestSkill` 字段为空导致覆盖率 `50%`，符合“按真实元数据统计”的预期；主线切换到 `StageB-SliceB3`。
- `2026-02-19`：完成 StageB-SliceB3 第一版实现：新增 `HCIAbilityKit.AuditScanAsync [batch_size] [log_top_n]` 分片扫描命令与 `HCIAbilityKit.AuditScanProgress` 进度查询命令；扫描过程中输出 `progress=% processed=n/total`，完成后输出摘要与样本行。
- `2026-02-19`：外部编译通过（`Build.bat HCIEditorGenEditor Win64 Development -Project=... -WaitMutex -FromMSBuild`），B3 进入“待 UE 手测”状态。
- `2026-02-19`：用户完成 B3 手测并反馈 `Pass`：`HCIAbilityKit.AuditScanProgress` 空闲状态返回 `progress=idle`；执行 `HCIAbilityKit.AuditScanAsync 1 20` 后输出 `start total=2 batch_size=1`、`50%/100%` 进度、完成摘要与样本行，结束后再次查询返回 `progress=idle`；主线切换到 `StageB-SliceB4`。
- `2026-02-21`：路线补充：确认“先收尾 B4->D3，再进入 Stage E（Agent 安全执行）与 Stage F（指令解析与编排）”；并建立后续增强“储备池”。
- `2026-02-21`：一期裁剪冻结：深做 Plan JSON/Tool Registry/Dry-Run+CameraFocus 与三维业务闭环（资产规范合规/关卡场景排雷/命名溯源整理）；极简实现阈值50、全单事务、SC Fail-Fast、本地 Mock 鉴权日志；延期记忆 TTL 与线上 KPI 到 Phase 3。
- `2026-02-21`：补充冻结细则：`args_schema` 严格枚举边界、Actor/资产定位兜底、SC 离线本地模式、未命中用户默认 `Guest(read_only)`、LOD 工具拦截 Nanite 资产。
- `2026-02-21`：一期业务覆盖面补充冻结：Rule Registry 与 Tool Registry 必须同时覆盖三维能力（资产规范合规、关卡场景排雷、命名溯源整理），并补充 Stage E/F 对应用例门禁。
- `2026-02-21`：完成 `StageB-SliceB4`（任务中断/重试/失败收敛）：新增 `AuditScanAsyncStop` 与 `AuditScanAsyncRetry` 命令，`Progress` 增加 cancelled/failed 状态输出；用户 UE 手测命中 `interrupted ... can_retry=true` 与 `retry start ...`，反馈 `OK`，主线切换到 `StageB-SliceB5`。
- `2026-02-21`：完成 `StageB-SliceB5`（triangle_count Tag 采集与来源标记）：审计摘要新增 `triangle_tag_coverage`，行日志新增 `triangle_count_lod0/triangle_source/triangle_source_tag`；用户 UE 手测命中 `triangle_tag_coverage=99.5%` 且多条 `triangle_source=tag_cached`，反馈 `Pass`，主线切换到 `StageB-SliceB6`。
- `2026-02-21`：完成 `StageB-SliceB6`（Locked/Dirty 状态过滤与跳过留痕）：审计摘要新增 `skipped_locked_or_dirty`，行日志新增 `scan_state/skip_reason`，并覆盖 `package_dirty/package_read_only` 两类原因；用户反馈 `Pass`，主线切换到 `StageB-SliceB7`。
- `2026-02-21`：完成 `StageB-SliceB7`（预览体可视化验证）：新增 `AHCIAbilityKitPreviewActor`，支持 `OnConstruction/RefreshPreview` 读取 `RepresentingMesh` 显示；用户手测反馈“完美通过（Pass）”，主线切换到 `StageB-SliceB8`。
- `2026-02-21`：修复 B7 手测发现的 Details 分类混淆：`HCI|Audit` 调整为 `HCIAudit`，避免层级分组与历史缓存导致的重复观感。
- `2026-02-22`：检索基线性能优化：`FHCIAbilityKitSearchIndexService` 将统计更新从全量重算改为增量更新（`UpdateDocumentStats`），`RefreshAsset/RemoveAssetByPath` 的统计维护由 `O(N)` 降至 `O(1)`；补充自动化基准用例 `HCIAbilityKitSearchIndexPerfTests`（1000 transient 资产压测主流程）。
- `2026-02-22`：检索基线一致性增强：`RefreshAsset/RemoveAssetByPath` 升级为“先校验、后提交、失败回滚”的原子更新流程；新增自动化用例 `HCIAbilityKit.Editor.SearchIndex.AtomicRefreshRollback`，并通过 `UnrealEditor-Cmd` 验证回滚链路。
- `2026-02-22`：补充原子负向门禁：新增 `HCIAbilityKit.Editor.SearchIndex.AtomicRemoveStaleMappingGuard`，覆盖 stale mapping（映射存在/索引缺失）失败收敛；验证 `RemoveAssetByPath` fail-fast 且统计不漂移，自动化测试通过。
- `2026-02-22`：完成 `StageB-SliceB8` 并通过：`AHCIAbilityKitPreviewActor` 增加 `PostEditChangeProperty` 与 `RepresentingMesh` 变更监听；Factory 在 Import/Reimport 成功后主动刷新绑定该 `AbilityAsset` 的预览体；用户反馈 `Pass`，主线切换到 `StageC-SliceC1`。
- `2026-02-22`：完成 `StageC-SliceC1` 实装（待 UE 手测）：新增 Runtime `IHCIAbilityAuditRule + RuleRegistry` 框架并注册默认规则 `TriangleExpectedMismatchRule`；导入链路新增可选 `params.triangle_count_lod0` 解析并写入资产 Tag `hci_triangle_expected_lod0`；`AuditScan/AuditScanAsync` 接入规则执行与 issue 统计（`issue_assets/info/warn/error`），并新增自动化测试 `HCIAbilityKit.Editor.AuditRules.*` 通过。
- `2026-02-22`：用户完成 `StageC-SliceC1` UE 手测并反馈通过：同步/异步扫描无异常，`triangle_expected_lod0/audit_issue_count/first_issue_rule` 行字段完整，且在 expected 缺失样本下 `issue_assets/info/warn/error=0` 符合规则设计；主线切换到 `StageC-SliceC2`。
- `2026-02-22`：完成 `StageC-SliceC2` 实装（待 UE 手测）：新增 `HighPolyAutoLODRule`（基于 `Triangles + LODs + NaniteEnabled`，高面数且缺少额外 LOD 时 `Warn`）与 `TextureNPOTRule`（基于 `Dimensions`，非 2 的幂次方时报 `Error`）并纳入默认 RuleRegistry；扫描行新增 `class/mesh_lods/mesh_nanite/tex_dims` 字段；自动化测试扩展至 4 条 `HCIAbilityKit.Editor.AuditRules.*` 全部通过。
- `2026-02-22`：用户完成 `StageC-SliceC2` UE 手测并反馈通过：新增行字段 `class/mesh_lods/mesh_nanite/tex_dims` 输出完整；3 个“非 Nanite + 高面数 + 单 LOD”样本均命中 `HighPolyAutoLODRule`（摘要 `issue_assets=3 issue_warn=3` 与行日志一致）；`TextureNPOTRule` 未在当前 AbilityAsset 扫描源中自然触发，符合范围预期；主线切换到 `StageC-SliceC3`。
- `2026-02-22`：完成 `StageC-SliceC3` 实现（待用户 UE 手测门禁）：Runtime 新增统一审计结果结构 `AuditReport/AuditResultEntry` 与 `SeverityToString`；新增 `AuditReportBuilder` 将 `ScanSnapshot` 扁平化为统一 `results[]`；扫描行日志新增 `first_issue_severity_name`；编译通过，自动化 `HCIAbilityKit.Editor.AuditResults`（2/2）与 `HCIAbilityKit.Editor.AuditScanAsync`（2/2）通过。
- `2026-02-22`：用户完成 `StageC-SliceC3` UE 手测并反馈通过：同步/异步扫描均正常完成；行日志新增 `first_issue_severity_name` 字段；命中 `HighPolyAutoLODRule` 的样本满足 `first_issue_severity=1 <-> first_issue_severity_name=Warn` 映射一致；主线切换到 `StageC-SliceC4`。
