# HCIAbilityKit 技术方案（插件双模块 + 资产审计优先）

> 状态：冻结（M0-V3）
> 版本：v3
> 更新时间：2026-02-15

## 1. 重构目标

- 当前方向从“检索实验”升级为“资产审计工具主线”。
- 核心交付：在 UE 编辑器内完成大规模资产扫描、规则审计、风险报告与可追踪复核。
- AI 定位：加分项，不是主链路依赖；主链路必须在无 AI 情况下稳定可用。
- 本期目标（半月内）：先完成 C++ 高性能审计骨架与可演示闭环，再接入 AI 视觉诊断增强。

## 2. 架构选择（冻结）

```text
Plugins/HCIAbilityKit/
  HCIAbilityKit.uplugin
  Source/
    HCIAbilityKitRuntime/
    HCIAbilityKitEditor/
```

- `HCIAbilityKitRuntime`：规则模型、扫描服务、指标提取、报告结构。
- `HCIAbilityKitEditor`：审计命令入口、进度反馈、结果面板、导出工具。
- 依赖必须单向：`Editor -> Runtime`。

## 3. 核心能力分层

### A. 扫描执行层（主链路，必须无阻塞）

- Stage B 启动前先接入“种子资产”集合（真实高面数 `UStaticMesh`），作为审计样本基座。
- 资产枚举基于 `AssetRegistry + FAssetData`，禁止默认全量 `LoadObject`。
- 扫描执行采用异步分片（TaskGraph/Async），UI 线程仅负责进度与交互。
- 扫描结果按批次汇聚，支持中断、重试、继续。

### B. 审计规则层（主链路，必须可配置）

- 固定规则：命名规范、目录规范、基础性能阈值、字段一致性。
- 审计结果统一结构：`asset_path/rule_id/severity/reason/hint/evidence`。
- 规则执行与结果汇总在 Runtime，Editor 仅做展示与导出。
- 规则扩展方式：通过 `IHCIAbilityAuditRule + RuleRegistry` 注入新规则，避免改动扫描主流程。

### C. 内存控制层（主链路，必须稳定）

- 元数据扫描路径不加载资产体。
- 深度检查路径采用小批量加载与主动释放策略（`FStreamableManager`/等效机制：Batch Load -> Analyze -> Release）。
- 每批分析结束后清理强引用，并按节流策略调用 `CollectGarbage`，防止 10k 审计持续累积内存。
- 记录峰值内存与处理批次，避免编辑器长时间卡顿。
- 扫描前做状态过滤：`Locked` 或 `Dirty 且无法安全读取` 的资产跳过并记录原因，禁止强行读取。

### C.1 Triangle Count 提取策略（冻结）

- 一级路径：读取 `AssetRegistry Tag`（例如 `hci_triangles_lod0`）。
- 二级路径：Tag 缺失时，在 Stage D 执行分批加载，提取 `StaticMesh LOD0 Triangles`。
- 口径优先级：真实网格提取值（actual）高于 JSON 预置值（expected）；冲突触发 `TriangleExpectedMismatchRule`。
- 证据要求：每条性能判定必须记录 `triangle_source(tag_cached/batch_loaded/unavailable)`。

### C.2 引用链契约（冻结）

- `UHCIAbilityKitAsset` 增加 `RepresentingMesh`（`TSoftObjectPtr<UStaticMesh>`），用于指向真实项目网格。
- 10k 合成数据导入时，允许按“种子网格清单”给每条资产分配 `RepresentingMesh` 路径。
- 种子清单路径统一采用 UE 长对象路径（`/Game/.../Asset.Asset`）；文件系统路径解析不在 Python 脚本中执行。
- 扫描阶段不强制加载该网格；仅在深度提取阶段分批加载并调用 `GetNumTriangles(0)`。
- 目标：审计结果必须可追踪到真实网格路径，而非仅依赖 JSON 离线字段。

### D. AI 视觉增强层（加分项，最后阶段）

- 对高风险候选资产进行截图并调用多模态模型做视觉诊断。
- 触发边界：仅 `Critical` 或用户手动复核条目，禁止随全量扫描自动触发。
- 线程边界：截图与渲染调用仅允许在主线程/Game Thread；后台线程只负责任务编排与结果聚合。
- 输出为“建议证据”，不直接覆盖规则判定。
- AI 不可用时，主链路可用率必须 100%。

## 4. 真实业务场景约束（冻结）

- `S1`：项目发版前，快速扫描全量资产，识别高风险性能浪费项。
- `S2`：美术提交后，自动发现命名/目录/基础参数不合规项。
- `S3`：针对疑似问题资产，生成可读审计报告供 TA/客户端协作复核。
- `S3.1`：策划将 `HCIAbilityKitAsset` 拖入场景时，可通过 `RepresentingMesh` 看到真实代表模型。
- `S4`（加分）：对疑似视觉问题资产给出 AI 视觉诊断建议。

## 5. 职责分配（最小集合）

- `Runtime`
  - `AssetScanService`：异步分片扫描
  - `SeedMeshBindingService`：种子网格清单读取与 `RepresentingMesh` 绑定策略
  - `AuditRuleService`：规则执行与严重级别归一
  - `AuditRuleRegistry`：规则注册、启停与排序
  - `AuditReportService`：结果汇总与导出结构
  - `MemoryBudgetPolicy`：批次与峰值内存约束
- `Editor`
  - `AuditCommand`：审计任务启动/停止
  - `AuditPanel`：进度、吞吐、内存、结果展示
  - `AuditExportAction`：JSON/CSV 报告导出
  - `AbilityKitPreviewActor`：内置 `UStaticMeshComponent`，读取 `RepresentingMesh` 并在场景中可视化
  - `AbilityKitPreviewActor`（编辑器同步）：`PostEditChangeProperty` 响应资产或路径变化并自动刷新网格
- `Python/AI`（后置）
  - `VisionReviewHook`：截图推理与诊断文本补充

## 6. 技术演进路线（Roadmap）

1. **Stage A 文档与契约冻结**：审计目标、规则契约、`RepresentingMesh` 引用链与启动门禁冻结。
2. **Stage B C++ 异步扫描主链路**：先接入种子资产并打通引用链，再实现非阻塞扫描与进度回传。
3. **Stage C 规则审计与报告闭环**：产出可追踪可导出的审计结果。
4. **Stage D 内存与吞吐优化**：批次策略、峰值监控、真实网格面数提取稳定性回归。
5. **Stage E AI 视觉增强（加分项）**：截图分析、语义诊断、降级保障。

## 7. 质量约束

- Runtime 禁止依赖 Editor-only 模块。
- 审计失败不得脏写资产。
- 所有错误必须可定位：`asset/file/rule/reason/hint`。
- 扫描过程不得阻塞编辑器主交互。
- AI 调用失败不得影响主链路可用性。

## 8. 验收口径（半月 Demo）

- 元数据扫描：10k 资产可完成扫描并输出报告。
- 真实性：10k 资产具备真实 `RepresentingMesh` 引用，审计可追踪到项目内网格。
- 交互体验：扫描期间编辑器可继续操作（无明显卡死）。
- 审计结果：每条异常均含规则ID、原因、建议与证据。
- 可靠性：AI 模块关闭时，主链路仍可完整运行。

## 9. 已冻结技术选型（2026-02-15）

- 扫描基线：`AssetRegistry + FAssetData`。
- 并发基线：UE 异步任务系统（TaskGraph/Async，按实现选择其一）。
- 报告格式：JSON（主）+ CSV（可选）。
- AI 接入：UE 内置 Python + 外部多模态 API（后置阶段）。
