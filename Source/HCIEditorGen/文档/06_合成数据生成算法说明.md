# HCIAbilityKit 合成数据生成算法说明（资产审计/检索双用途）

> 状态：冻结（V3）
> 更新时间：2026-02-15
> 适用范围：
> - `SourceData/AbilityKits/Python/hci_build_seed_mesh_manifest.py`
> - `SourceData/AbilityKits/Python/hci_generate_synthetic_assets.py`

## 1. 目标与定位

- 目标：生成 `10,000` 条可导入 `.hciabilitykit` 源数据，用于检索与资产审计双场景验证。
- 定位：这是主线测试数据基建，不是业务逻辑替代，不推进切片。
- 核心验证点：
  - 检索规模（10k 级）
  - 语义鸿沟（name 无关键词但 description 有语义）
  - 复合误导（语义陷阱 + 性能陷阱）

## 2. 与当前契约对齐（向后兼容）

- 保留现有导入必填字段（Runtime 解析依赖）：
  - `schema_version`
  - `id`
  - `display_name`
  - `params.damage`
- 扩展压测字段（当前解析可忽略）：
  - `name`
  - `type`（`StaticMesh/Sound/VFX`）
  - `virtual_path`（目录语义）
  - `representing_mesh`（Stage B 增强项：指向真实种子网格）
  - `tags`（数组）
  - `description`（长文本）
  - `params.*`（如 `triangle_count_lod0/size/radius/duration/cooldown/...`）

## 3. 生成算法（可复现）

### 3.1 配额计算

- 输入参数：`N=count`，`r_gap=semantic_gap_ratio`，`r_trap=trap_ratio`，`seed`。
- Stage B 参数：`seed_mesh_manifest`（真实种子网格路径列表）。
- 约束：`0 <= r_gap <= 1`，`0 <= r_trap <= 1`，`r_gap + r_trap <= 1`。
- 配额：
  - `gap_target = round(N * r_gap)`
  - `trap_target = round(N * r_trap)`

### 3.2 抽样流程

1. 用 `seed` 初始化随机源并打乱全量索引。
2. 前 `gap_target` 个索引标记为 `semantic_gap`。
3. 在剩余索引中取前 `trap_target` 个标记为 `trap`。
4. 逐条生成：
   - `performance_trap`：生成“LowPoly 路径 + 超高面数”冲突样本；
   - `semantic_trap`：生成“命名误导 + 描述反证”冲突样本；
   - 非 `trap`：按 `semantic_gap` 与否走普通/鸿沟模板；
   - 若提供 `seed_mesh_manifest`：为每条数据分配 `representing_mesh`（随机或轮询）。

### 3.3 路径契约与职责边界（冻结）

- `seed_mesh_manifest` 内路径必须使用 UE 长对象路径：`/Game/.../Asset.Asset`。
- Python 脚本只写入路径字符串，不负责解析 `.uasset` 文件系统映射。
- 真正的解析与有效性校验在 `UHCIAbilityKitFactory` 导入阶段执行；无效路径应触发 `E1006`。

### 3.4 分布策略

- `theme` 加权：`fire 0.38 / ice 0.30 / forest 0.32`
- `type` 加权：`StaticMesh 0.35 / Sound 0.20 / VFX 0.45`
- `damage` 范围：
  - `fire`: `180~520`
  - `ice`: `120~340`
  - `forest`: `70~260`
- 目的：避免“完全均匀”导致的玩具数据分布。

## 4. 语义鸿沟与陷阱定义

## 4.1 语义鸿沟（目标约 30%）

- 定义：`name` 不出现核心关键词，但 `description` 出现核心关键词。
- 核心关键词词库：
  - Fire：`fire/flame/burn/ember/inferno`
  - Ice：`ice/frost/chill/blizzard/glacier`
  - Forest：`forest/nature/jungle/grove/vine`
- 示例：`name="Silent Mirror Prime"`，`description` 明确包含 `ice` 语义。

## 4.2 语义陷阱（Trap 子集）

- 定义：名称带误导词，但描述给出反证（例如“not elemental / deals physical damage”）。
- 示例：`Ice_Sword_*`，描述为 “cold look but deals physical damage.”
- 作用：验证检索是否只看 name，还是能处理多字段冲突。

## 4.3 性能陷阱（Trap 子集）

- 定义：目录或命名语义指向“低复杂度”，但 `triangle_count_lod0` 极高。
- 示例：
  - `name=Small_Rock_*`
  - `virtual_path=/Game/Art/Env/LowPoly/Rocks/`
  - `params.triangle_count_lod0=100000`
- 作用：验证“目录语义 + 面数指标”的冲突审计能力。

## 4.4 面数预期值与真实值冲突（审计口径）

- `params.triangle_count_lod0` 在生成数据中属于“预期值”（expected）。
- Stage B~D 审计应以真实 `RepresentingMesh` 提取得到的面数为准（actual）。
- 当 `actual != expected` 时，报告应触发 `TriangleExpectedMismatchRule`（`severity=Warn`）。

## 5. 产物与验证

- 输出目录：`SourceData/AbilityKits/Generated/`
- 输出文件：
  - `*.hciabilitykit`（逐条资产）
  - `generation_report.json`（统计摘要）
- Seed 清单文件：
  - `SourceData/AbilityKits/seed_mesh_manifest.json`
- 单测文件：
  - `SourceData/AbilityKits/Python/tests/test_hci_build_seed_mesh_manifest.py`
  - `SourceData/AbilityKits/Python/tests/test_hci_generate_synthetic_assets.py`
- 单测覆盖：
  - 字段结构完整性
  - `semantic_gap` 比例与定义
  - `trap` 比例与冲突断言（含 `trap:performance`）
  - `representing_mesh` 覆盖率与路径有效性断言。

## 6. 复现命令（UV Python）

### 6.1 生成/校验 Seed Mesh Manifest（Stage B0）

```powershell
& "C:\Users\50428\AppData\Roaming\uv\python\cpython-3.11.14-windows-x86_64-none\python.exe" `
  SourceData/AbilityKits/Python/hci_build_seed_mesh_manifest.py build `
  --project-root . `
  --content-dir Content `
  --seed-subdir Seed `
  --seed-root /Game/Seed `
  --name-prefix SM_ `
  --output-file SourceData/AbilityKits/seed_mesh_manifest.json
```

```powershell
& "C:\Users\50428\AppData\Roaming\uv\python\cpython-3.11.14-windows-x86_64-none\python.exe" `
  SourceData/AbilityKits/Python/hci_build_seed_mesh_manifest.py validate `
  --manifest-file SourceData/AbilityKits/seed_mesh_manifest.json `
  --expected-seed-root /Game/Seed
```

### 6.2 生成 10k 数据并绑定真实网格引用

```powershell
& "C:\Users\50428\.local\bin\uv.exe" run --python "C:\Users\50428\AppData\Roaming\uv\python\cpython-3.11.14-windows-x86_64-none\python.exe" `
  SourceData/AbilityKits/Python/hci_generate_synthetic_assets.py `
  --count 10000 `
  --seed 20260215 `
  --semantic-gap-ratio 0.3 `
  --trap-ratio 0.12 `
  --seed-mesh-manifest SourceData/AbilityKits/seed_mesh_manifest.json `
  --output-dir SourceData/AbilityKits/Generated
```

## 7. 当前限制与后续建议

- 当前检索主链仍以 `id/display_name` 规则为主，`description/tags` 尚未进入正式召回打分。
- 因此这批数据已具备“语义评测价值”，但要验证真正 NLP 理解能力，需要后续把 `description/tags` 纳入索引与召回策略。
- 若未传 `--seed-mesh-manifest`，脚本不会写入 `representing_mesh`，数据将退化为“无真实网格证据链”模式。
- 资产审计方向需在 Stage B~D 接入 `triangle_source` 与 RuleRegistry，才能把“性能陷阱”纳入正式门禁报告。
