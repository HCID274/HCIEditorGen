# HCIAbilityKit 测试门禁与节奏

> 状态：冻结（M0-V3）
> 版本：v3
> 更新时间：2026-02-21

## 1. 总体规则（强制）

- 每完成一个切片必须停下，等待用户在 UE 手测。
- 用户未明确 `Pass`，不得进入下一切片。
- 每次验证必须有记录文件，不允许口头“通过”。
- 所有写操作能力必须覆盖失败路径验证（禁止只测成功路径）。

## 2. 标准切片流程

1. 冻结当前切片目标（只做一件事）。
2. 完成实现并本地编译通过。
3. 提供 UE 手测步骤、预期结果、Pass/Fail 标准。
4. 用户执行 UE 手测并反馈结论。
5. 写入测试记录后，才可推进下一切片。

## 3. 测试资产留存

- 测试源数据目录：`SourceData/AbilityKits/`
- 测试记录目录：`Source/HCIEditorGen/文档/测试记录/`
- 推荐记录命名：`YYYY-MM-DD_StageX-SliceY_结果.md`

## 4. 分阶段测试重点

### Stage A-D（资产审计主链路）

- 回归目标：导入、扫描、规则、报告、内存稳定性全部可复现。
- 必测项：
  - Import/Reimport 成功与失败路径；
  - `AssetRegistry + FAssetData` 扫描覆盖率；
  - 异步分片扫描进度与不中断交互；
  - RuleRegistry 命中证据与 JSON 导出；
  - 批次加载与 GC 节流稳定性。

### Stage E（Agent 安全执行）

- 回归目标：写操作必须“可预演、可确认、可撤销、可拦截”。
- 必测项：
  - `Tool Registry` 能力声明与 `args_schema` 严格校验；
  - `Dry-Run Diff` 展示与定位兜底；
  - Blast Radius 阈值拦截（`MAX_ASSET_MODIFY_LIMIT=50`）；
  - `ScopedTransaction` 全单回滚；
  - SourceControl 离线/在线分支行为；
  - 本地 Mock RBAC 与 Guest 默认只读。

### Stage F（指令解析与执行编排）

- 回归目标：自然语言可稳定转为可执行 Plan，执行结果可追踪。
- 必测项：
  - `Plan JSON` 必填字段校验；
  - 非白名单工具拦截；
  - 写操作未确认拦截；
  - 步骤级错误码与终止策略一致。

## 5. 固定回归最小集

- `R1` 可导入：`*.hciabilitykit` 成功生成资产。
- `R2` 可重导：修改源文件后右键 `Reimport` 生效。
- `R3` 不脏写：失败导入/重导不会污染已有资产。
- `R4` 可定位：日志含文件、字段、原因、建议。
- `R5` 可解释：审计结果含命中依据，非黑盒输出。
- `R6` 可回滚：事务失败触发全单回滚。

## 6. Stage E/F 门禁用例（新增，必须执行）

### E_GATE_01 `args_schema` 枚举边界校验

- 步骤：构造 `SetMeshLODGroup`，传入未声明 `lod_group`（如 `UltraLOD`）。
- 预期：拦截并返回 `E4009`，不产生写操作。

### E_GATE_02 UE 定位兜底

- 步骤：Dry-Run 列表分别选中场景 Actor 与 `Texture2D` 资产。
- 预期：Actor 触发 `Camera Focus`；`Texture2D` 触发 `SyncBrowserToObjects`。

### E_GATE_03 SourceControl 离线模式

- 步骤：禁用 SourceControl 后执行写操作计划。
- 预期：打印 Warning“离线本地模式”，允许继续执行。

### E_GATE_04 SourceControl 在线 Fail-Fast

- 步骤：启用 SourceControl，制造 `Checkout` 失败。
- 预期：立即中断整单并返回 `E4006`，不做自动重试。

### E_GATE_05 RBAC 默认 Guest

- 步骤：使用未命中映射用户名执行 `write` 工具。
- 预期：用户降级为 `Guest(read_only)`，阻断写操作并返回 `E4008`。

### E_GATE_06 LOD 工具安全边界

- 步骤：对非 `UStaticMesh` 资产与 `NaniteSettings.bEnabled=true` 网格调用 `SetMeshLODGroup`。
- 预期：均被拦截并返回 `E4010`。

### E_GATE_07 Blast Radius 阈值

- 步骤：写操作目标资产数设为 `51`。
- 预期：直接拦截并返回 `E4004`。

### E_GATE_08 全单事务回滚

- 步骤：计划中前半成功、后半故意失败。
- 预期：整单回滚，最终无部分写入，返回 `E4007`。

### E_GATE_09 关卡排雷工具覆盖

- 步骤：在关卡内构造 1 个无碰撞 `StaticMeshActor` 与 1 个默认材质 `StaticMeshActor`，执行 `ScanLevelMeshRisks`（`scope=selected` 与 `scope=all` 各一次）。
- 预期：返回两类证据（`missing_collision/default_material`），并可通过 UI 对应触发 `Camera Focus` 定位。

### E_GATE_10 关卡排雷参数边界

- 步骤：调用 `ScanLevelMeshRisks`，传入非法 `scope=partial` 或非法 `checks=["invalid_check"]`。
- 预期：拦截并返回 `E4011`，不执行扫描。

### E_GATE_11 命名溯源归档工具覆盖

- 步骤：对临时目录资产执行 `NormalizeAssetNamingByMetadata` Dry-Run，元数据来源分别覆盖 `UAssetImportData` 与 `AssetUserData`。
- 预期：生成 `SM_/T_` 前缀命名提案与 Move 归档提案；确认后执行 `RenameAsset + MoveAsset`，日志含 `importer/import_timestamp/metadata_source`。

### E_GATE_12 命名溯源缺失收敛

- 步骤：构造无可用元数据资产执行 `NormalizeAssetNamingByMetadata`。
- 预期：拦截并返回 `E4012`，禁止盲目改名/移动。

### F_GATE_01 Plan 必填字段校验

- 步骤：提交缺失 `tool_name` 或 `rollback_strategy` 的 Plan。
- 预期：拦截并返回 `E4001`。

### F_GATE_02 白名单与确认门禁

- 步骤：提交非白名单工具；提交 `requires_confirm=true` 且未确认的写计划。
- 预期：分别返回 `E4002`、`E4005`。

## 7. 单次测试记录模板（必填）

- 切片编号：
- 目标功能：
- 影响范围：
- 前置条件：
- 操作步骤：
- 预期结果：
- 实际结果：
- 结论（Pass/Fail）：
- 证据路径（日志/截图/录屏）：
- 备注/遗留问题：
