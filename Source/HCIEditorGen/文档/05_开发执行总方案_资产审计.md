# HCIAbilityKit 开发执行总方案（资产审计优先，半月冲刺版）

> 状态：冻结（V3）
> 更新时间：2026-02-21
> 适用范围：`HCIAbilityKit` 资产审计主链路

## 1. 模块定位与边界（先定死）

- 本期主交付：`Smart Asset Auditor`（资产审计系统）。
- 本期目标：在 UE 内实现“可扩展规则审计 + 非阻塞扫描 + 可导出报告”。
- 非目标（本期不做）：
  - 无确认的全自动批量修复并回写资产；
  - 大而全流程平台化；
  - 多引擎适配与跨项目平台治理。

## 2. 半月交付目标（固定）

- `T+15` 前形成可演示闭环：
  - 10k 级资产扫描与审计可跑通；
  - 编辑器交互不中断；
  - 结果可追踪、可导出。
- `T+15` 后主线衔接：
  - 进入 `Stage E`（Agent 安全执行）；
  - 再进入 `Stage F`（指令解析与执行编排）。

## 3. 主线切片（唯一执行顺序）

### Stage A：文档与契约冻结（Day 1-2）

- `Slice A1`：路线重规划落文档（目标、边界、门禁）。
- `Slice A2`：审计结果契约与指标口径冻结（含 Triangle 提取来源与 RuleRegistry 约束）。
- `Slice A3`：Stage B 实战资产导入方案冻结（种子资产来源、RepresentingMesh 引用链、启动门禁）。
- 门禁：文档一致、术语一致、流程一致。

### Stage B：实战资产导入 + C++ 异步扫描主链路（Day 3-7）

- 前置门禁：仅在 `Stage A-SliceA3` 明确 `Pass` 后启动实现。
- `Slice B0`：种子资产清单接入（`/Game/.../Seed/`）与 `seed_mesh_manifest` 生成（来源允许 Quixel Bridge Nanite/AI 3D 导入高面数模型，路径固定 UE 长对象路径 `/Game/.../Asset.Asset`，禁止 OS 文件路径）。
- `Slice B1`：`UHCIAbilityKitAsset` 增加 `RepresentingMesh(TSoftObjectPtr<UStaticMesh>)` 并打通导入绑定。
- `Slice B2`：`AssetRegistry + FAssetData` 全量枚举（资产元数据 + `RepresentingMesh` 路径）。
- `Slice B3`：异步分片执行与进度汇报（UI 非阻塞）。
- `Slice B4`：任务中断/重试与失败收敛。
- `Slice B5`：采集 `triangle_count` 相关 Tags（若存在），标记 `triangle_source=tag_cached`。
- `Slice B6`：状态过滤（跳过 `Locked` 或 `Dirty 且无法安全读取` 的资产，记录跳过原因）。
- `Slice B7`：数据驱动预览体（Blueprint/C++ Actor）读取 `RepresentingMesh`，支持拖入场景可视化验证（Actor 内置 `UStaticMeshComponent`）。
- `Slice B8`：预览体自动同步：`PostEditChangeProperty` 响应资产/路径变更；Reimport 后刷新显示网格。
- 门禁：扫描过程中可持续编辑器操作，无明显冻结。

### Stage C：规则审计与报告闭环（Day 8-11）

- `Slice C1`：规则框架（`IHCIAbilityAuditRule + RuleRegistry`，含 `TriangleExpectedMismatchRule`）。
- `Slice C1.1`：一期业务覆盖（三维缺一不可）：
  - 维度1 资产规范合规：`TextureNPOTRule`（贴图宽高非 2 的幂次方报错）+ `HighPolyAutoLODRule`（`LOD0 triangles > 10000` 且缺失 LOD 报警，修复动作为 `LODGroup=LevelArchitecture`，仅 `UStaticMesh` 且 `NaniteSettings.bEnabled=false`）；
  - 维度2 关卡场景排雷：`MissingCollisionRule`（静态网格体缺失碰撞）+ `DefaultMaterialRule`（静态网格体使用默认材质）；
  - 维度3 命名与溯源整理：`MetadataNamingRule`（基于 `UAssetImportData/AssetUserData` 的命名前缀规范）+ `ArchiveMoveRule`（临时目录资产批量归档路径规范）。
- `Slice C2`：统一审计结果结构与严重级别。
- `Slice C3`：JSON 报告导出（可追踪字段完整，含 `triangle_source`）。
- 门禁：审计异常均具备 `rule_id/reason/hint/evidence`。

### Stage D：内存与吞吐优化（Day 12-15）

- `Slice D1`：深度检查批次策略（使用 `FStreamableManager` 或等效加载机制分批同步加载 `RepresentingMesh`；提取后立即释放强引用）。
- `Slice D2`：GC 节流策略（每 N 批调用一次 `CollectGarbage`，并记录批次耗时与内存峰值）。
- `Slice D3`：峰值内存与吞吐日志监控。
- 门禁：批量审计稳定，无持续内存飙升。

### Stage E：Agent 安全执行（D3 通过后立即启动）

- `Slice E1`：Tool Registry 能力声明冻结（白名单 + 能力元信息）：
  - 每个 Tool 必填：`tool_name/args_schema/read_only|write/destructive/supports_dry_run/supports_undo`。
  - `args_schema` 必须冻结枚举与边界值，禁止自由参数扩展（示例：`SetMeshLODGroup.lod_group` 仅允许预设枚举）。
  - 一期白名单必须覆盖三维业务：`SetTextureMaxSize`、`SetMeshLODGroup`、`ScanLevelMeshRisks`、`NormalizeAssetNamingByMetadata`、`RenameAsset`、`MoveAsset`。
- `Slice E2`：Dry-Run Diff 契约与 UE 面板展示：
  - 输出标准 Diff：`asset_path/field/before/after/tool_name/risk/skip_reason`；
  - UE 列表支持定位兜底：Actor 走 `Camera Focus`，纯资产走 `SyncBrowserToObjects` 高亮。
- `Slice E3`：确认门禁（未确认不得执行写操作）。
- `Slice E4`：Blast Radius 极简限流（硬编码）：
  - `MAX_ASSET_MODIFY_LIMIT = 50`；超过阈值直接拦截并提示分批执行。
- `Slice E5`：`ScopedTransaction` 全单事务（All-or-Nothing）：
  - 成功全提交；任一步失败则整单回滚。
- `Slice E6`：SourceControl Fail-Fast：
  - 若 SourceControl 未启用：Warning + 进入离线本地模式放行；
  - 若已启用：`Checkout` 任一步失败立即中断整单，不做自动重试/强制解锁。
- `Slice E7`：本地 Mock 鉴权与本地审计日志：
  - 本地角色表（按用户名）控制工具权限；
  - 未命中白名单默认 `Guest(read_only)`，阻断 `write/destructive`；
  - 日志写入本地 `json/txt`（时间/用户/动作/结果）。
- 门禁：破坏性操作必须“预演 -> 确认 -> 可撤销”；超阈值可拦截；`Checkout` 失败可立即收敛。

### Stage F：指令解析与执行编排（Stage E 通过后启动）

- `Slice F1`：自然语言 -> Plan JSON（结构化执行计划，契约冻结；必须支持“整理临时目录资产”等命名归档意图）。
- `Slice F2`：Plan 校验器（参数完整性、权限、风险级别、批量阈值）。
- `Slice F3`：Executor（按步骤调用 Tool Registry 并产出执行证据）。
- `Slice F4`：失败收敛（步骤级错误码、终止策略）。
- 门禁：任意指令都能得到“可解释计划 + 可追踪执行结果”。

## 4. 每个切片固定执行模板（强制）

1. 先写/改文档（目标、范围、门禁）。
2. 实现并命令行编译通过。
3. 输出 UE 手测步骤与 Pass/Fail 标准（用户执行）。
4. 记录测试结果与证据。
5. 未收到 Pass，不进入下一切片。

## 5. Demo 指标（面试可讲）

- `K1` 扫描吞吐：10k 资产扫描耗时（记录 P50/P95）。
- `K2` 交互稳定：扫描期间编辑器可操作（无长时间冻结）。
- `K3` 审计可解释：异常项解释覆盖率 100%。
- `K4` 结果可追踪：关键字段完整率 100%。

## 6. 风险与收束策略

- 风险：又回到“检索 demo”导致主线分散。
  - 收束：所有任务需映射“资产审计闭环”，不能映射就延期。
- 风险：1 万资产只绑定虚假字段，面数审计失真。
  - 收束：Stage B 必须先完成种子资产与 `RepresentingMesh` 引用链，未打通不得进入规则判定。
- 风险：扫描性能不稳。
  - 收束：先保证非阻塞，再谈复杂规则扩展。
- 风险：Stage D 批量加载后内存不释放导致编辑器 OOM。
  - 收束：强制执行“批次加载 -> 提取 -> 释放 -> 节流 GC”策略，并记录峰值内存。
- 风险：Python 侧写入路径与 UE 资产路径语义不一致。
  - 收束：`seed_mesh_manifest` 固定 UE 长对象路径；路径有效性只在 Factory 导入校验，失败落 `E1006`。
- 风险：LLM 误解指令导致批量误操作。
  - 收束：强制 Dry-Run 与人工确认门禁，禁止静默写入。
- 风险：一期实现面过宽导致延期。
  - 收束：一期禁止实现“记忆 TTL/记忆门禁细则”与“线上 KPI 监控体系”。

## 7. 变更规则（冻结）

- 本文档为当前唯一执行主计划。
- 主线调整必须先改本文档与 `00_总进度.md`，再改代码。
- 不允许口头改路线，所有变更需文档化并标注日期。

## 8. 储备池（可选增强，不阻塞主线）

- `R1`：三级记忆补全（长期 SOP 压缩、主动推荐 Proactive Suggestion）。
- `R2`：Web Dashboard（管理视角聚合看板）。
- `R3`：无感鉴权 + 后端权限中心（按用户角色限制工具能力）。
- `R4`：SourceControl 自动提交流（主线先做 Checkout/Revert）。
- `R5`：扩展自动修复动作库（主线先保证安全执行框架）。
- `R6`：完整对话式 Copilot UI（主线先交付计划预演与执行闭环）。

## 9. 一期裁剪决议（2026-02-21，冻结）

- 深做（必须做）：`Plan JSON 契约`、`Tool Registry 能力声明`、`Dry-Run Diff + UE 交互(Camera Focus)`，以及三维业务闭环（`资产规范合规`、`关卡场景排雷`、`命名溯源整理`）。
- 极简（Mock/Hardcode）：`MAX_ASSET_MODIFY_LIMIT=50`、`All-or-Nothing 事务`、`SourceControl Fail-Fast`、`本地 Mock 鉴权 + 本地日志`。
- 延期（Phase 3，不入一期代码）：记忆门禁/TTL、线上 KPI 监控体系。
